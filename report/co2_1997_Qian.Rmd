---
title: "Global $CO_{2}$ Emissions in 1997"
short: "What Keeling missed all these years"
journal: "AER" # AER, AEJ, PP, JEL
month: "`r format(Sys.Date(), '%m')`"
year: "`r format(Sys.Date(), '%Y')`"
vol: 0
issue: 0
keywords:
  - Replication
  - Modern Science
author:
  - name: Carolyn Dunlap
    firstname: Carolyn
    surname: Dunlap
    email: cadunlap@ischool.berkeley.edu
    affiliation: UC Berkeley, School of Information
  - name: Ayda Nayeb Nazar
    firstname: Ayda
    surname: Nayeb Nazar
    email: ayda@ischool.berkeley.edu
    affiliation: UC Berkeley, School of Information
  - name: Qian Qiao
    firstname: Qian
    surname: Qiao
    email: qianqiao@ischool.berkeley.edu
    affiliation: UC Berkeley, School of Information
  - name: Hector Rincon
    firstname: Hector
    surname: Rincon
    email: hector@ischool.berkeley.edu
    affiliation: UC Berkeley, School of Information
acknowledgements: | 
  The authors would like to thank their instructors from MIDS 271.
abstract: | 
  This study analyzes the time series of atmospheric CO2 concentrations from monitoring stations around the world that managed by the National Oceanic and Atmospheric Administration (NOAA). Our goal is to develop a model that accurately captures the trend and seasonality of CO2 concentrations over time, as well as any other relevant patterns or anomalies. To accomplish this, various time series modeling techniques are employed, including linear regression models and seasonal autoregressive integrated moving average (ARIMA) models. The analysis finds that a seasonal ARIMA model with a trend and seasonal difference term provides the best fit to the CO2 time series data. This model reveals a clear upward trend in CO2 concentrations over time, with seasonal variations superimposed on top of this trend.
   
header-includes: 
  - '\usepackage{graphicx}'
  - '\usepackage{booktabs}'
output: rticles::aea_article
---

```{r setup, echo=FALSE, warning=FALSE, results="hide", message=FALSE}
## default to not show code, unless we ask for it.
library(tidyverse)
library(tsibble)
library(latex2exp)
library(tsibble)
library(lubridate)
library(fable)
library(forecast)
library(dplyr)
library(feasts)
library(ggplot2)
library(gridExtra)
library(AICcmodavg)
library(feasts)
library(astsa)
library(patchwork)
library(tseries)
theme_set(theme_minimal())
knitr::opts_chunk$set(echo=FALSE)
options(digits = 3)
```

Climate change is one of the most pressing issues of our time. One of the key contributors to climate change is the increase in atmospheric carbon dioxide (CO2) levels. The Keeling Curve, created by Charles David Keeling, shows the steady increase in atmospheric $CO_{2}$ levels over time. What the trend and seasonality lies in the atmospheric $CO_{2}$ changing? How can we use the trend and seasonality to to model the future impacts of climate change? These are the core questions we want to address.This analysis will help us to have a better understanding on a changing climate and to develop strategies for mitigating its effects.

# Background

## Carbon Emissions

Carbon emissions are a major environmental concern because they contribute to the Earth's rising temperature, which can cause a range of negative impacts on the environment and human society. These impacts include sea-level rise, more frequent and severe weather events, changes in precipitation patterns, and the loss of biodiversity and ecosystem services.

# Measurement and Data

## Measuring Atmospheric Carbon

Our analysis will draw on atmospheric $CO_{2}$ data. The data on atmospheric carbon dioxide (CO2) levels is generated by the Global Monitoring Laboratory (GML) of the National Oceanic and Atmospheric Administration (NOAA), which operates a network of over 80 monitoring stations around the world. The data is collected through continuous measurements of atmospheric CO2 concentrations using highly precise instruments, such as gas chromatographs and infrared analyzers. One of the longest and most well-known records of this data is the Mauna Loa CO2 record, which has been collected since 1958 at the Mauna Loa Observatory in Hawaii.

These stations collect CO2 measurements on a continuous basis, with data typically collected every 10 to 15 minutes and measure the concentration of atmospheric CO2 using highly precise instruments, such as gas chromatographs and infrared analyzers.

## Historical Trends in Atmospheric Carbon

Monthly Atmospheric carbon from 1959 to 1997 is plotted in plot below. The time series plot shows an increasing trend from 1959 to 1997 and there is a seasonal fluctuations every year.

The ACF plot shows a slow decline and while the PACF plot drops sharply after the first lag and shows significance up to three lags, which confirmed our observation from the time series plot that the $CO_{2}$ data has a trend pattern.

```{r EDA plots, warning=FALSE, message=FALSE, Fig.height = 4}
ts_co2 <- as_tsibble(co2)
#time plot, histogram, ACF and PACF
p1_plot <- ggplot(ts_co2, aes(x = index, y = value)) +
  geom_line() +
  labs(
    title = TeX(r'(Monthly Mean $CO_2$ per Year)'),
    x = 'Month',
    y = TeX(r'($CO_2$ parts per million)')
  )
p3_acf <- ts_co2 %>%
  ACF(value) %>%
  autoplot() +
  labs(title=TeX(r'(ACF of Monthly Mean $CO_2$)'))
p4_pacf <- ts_co2 %>%
  PACF(value) %>%
  autoplot() +
  labs(title=TeX(r'(PACF of Monthly Mean $CO_2$)'))
p2_histogram <- ts_co2 %>%
  ggplot(aes(x = value)) +
  geom_histogram() +
  labs(title=TeX(r'(Histogram of Monthly Mean $CO_2$)'),
        x = TeX(r'($CO_2$ parts per million)'))

(p1_plot | p2_histogram) /
  (p3_acf | p4_pacf)
```

The seasonal plot displays a clear seasonality for each year. The atmospheric $CO_{2}$ level went to peak in April and May, and had the yearly lowest $CO_{2}$ pmm in September and October.

```{r, seaonal grap, warning=FALSE, Fig.height = 2.5}

#seasonal graph
seasonal_graph <- ts_co2 %>%
  gg_season(value) +
  labs(
    title = TeX(r'(Monthly Mean $CO_2$ per Year)'),
    subtitle = 'Seasonal Plot',
    x = 'Month',
    y = TeX(r'($CO_2$ parts per million)')
  )


seasonal_graph
```

Through the multiplicative composition plot, we observed a clear upward trend in overall $CO_2$ levels over time as well as seasonal patterns.

```{r, decompose plot, warning=FALSE, message=FALSE}
plot(decompose(co2, type="mult"), Fig.height = 4)
```

# Models and Forecasts

To investigate the trend, seasonal, and irregular elements of the $CO_2$ data, we used linear regression and ARIMA method to model the long-term increase in $CO_2$ levels over time.

## Linear Models

We begin by fitting the following simple linear model motivated by the linear trend observed in the EDA:

```{=tex}
\begin{equation}
\label{eq:one}
\text{CO}_{2} = \beta_0 + \beta t
\end{equation}
```
The model parameters are then estimated in the following way,

```{r loading data}
ts_co2 <- as_tsibble(co2)
```

```{r Fitting the linear model, echo=TRUE, results="hide"}
co2_reg <- ts_co2 %>% 
	model(TSLM(value ~ trend())) %>%
  report()
```

```{r linear model residuals}
co2_reg %>% gg_tsresiduals() + ggtitle("Linear Model Residuals")
```

Despite the strong linear trend observed in the time series plot, the residuals of the simple linear model to not appear to be white noise as showcases by the numerous significant lags and strong seasonal pattern in the ACF plot. We can attempt to rectify this by incorporating seasonal dummy variables into our model,

```{r Fit the seasonalized model, echo=TRUE, results="hide"}
co2_reg_season <- ts_co2 %>% 
	model(TSLM(value ~ trend() + season())) %>%
  report()
```

```{r seasonalized model report}
report(co2_reg_season)
```

```{r seasonalized model residulas}
co2_reg_season %>% gg_tsresiduals() + ggtitle("Linear Model with Seasonality Residuals")
```

The residuals for this model, however, result in lags that are all autocorrelated and a residual plot that forms a parabolic pattern, which is evidence against the hypothesis that a linear model can appropriately fit the data. A polynomial model may therefore be a more sensible option in order to capture the non-linearities in the data, so we then fit the following quadratic model:

```{=tex}
\begin{equation}
\label{eq:one}
\text{CO}_{2} = \beta_0 + \beta_1 t + \beta_2 t^2
\end{equation}
```
Estimating the parameters as follows,

```{r Quad model, echo=TRUE, results="hide"}
co2_quadratic <- ts_co2 %>% 
	model(TSLM(value ~ trend() + I(trend()^2))) %>% 
	report()
```

```{r Quad model residuals}
co2_quadratic %>% gg_tsresiduals() + ggtitle("Quadratic Model Residuals ")
```

The result is a more white-noise-like residual plot, but with strong seasonality still being showcased in the ACF plot. We can now attempt to rectify for the seasonality once more with the addition of a seasonal dummy variable,

```{r Quad model with seasonality, echo=TRUE, results="hide"}
co2_quadratic_season <- ts_co2 %>% 
	model(TSLM(value ~ trend() + I(trend()^2) + season())) %>% 
	report()
```

```{r Quad model with seasonality residuals}
co2_quadratic_season %>% gg_tsresiduals() + ggtitle("Quadratic Model with Seasonality Residuals")
```

but despite the addition of the seasonal term, a subtle seasonal pattern can still be observed in the ACF, along with all significant lags and strong autocorrelation in the ACF.

```{r, echo=FALSE,fig.height=6}
p1 <- augment(co2_reg)%>%
  ggplot(aes(x = index)) +
  geom_line(aes(y = value, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted")) +
  labs(y = "$CO_2$ parts per million",
       title = "CO2 Linear Model") 
p2 <-augment(co2_reg_season)%>%
  ggplot(aes(x = index)) +
  geom_line(aes(y = value, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted")) +
  labs(y = "$CO_2$ parts per million",
       title = "CO2 Linear + Seasonality")
p3 <-augment(co2_quadratic)%>%
  ggplot(aes(x = index)) +
  geom_line(aes(y = value, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted")) +
  labs(y = "$CO_2$ parts per million",
       title = "CO2 Quadratic Model") 
p4 <-augment(co2_quadratic_season)%>%
  ggplot(aes(x = index)) +
  geom_line(aes(y = value, colour = "Data")) +
  geom_line(aes(y = .fitted, colour = "Fitted")) +
  labs(y = "$CO_2$ parts per million",
       title = "CO2 Quadratic + Seasonality") 
grid.arrange(p1,p2,p3,p4, nrow = 2, ncol = 2)
```

From the fitted value plots, we can see that the simple linear and quadratic models capture the trend quite well, but fail to capture the seasonal fluctuations present in the data, although it's important to note that the quadratic model was slightly more successful at this than the linear model. The linear model corrected for seasonality attempts to better capture the seasonal effect and does much better job at doing so, but it underestimates the observed data. In the end, our final quadratic model with the additional seasonal dummy variable seems to do a good job capturing both trend and seasonal movement in the data,

```{r Information criteria}
# Compare the AIC, BIC btw linear model and quadratic model
ic.m1 <- glance(co2_reg) %>%
  dplyr::select(adj_r_squared, CV, AIC, AICc, BIC) %>% mutate(name="Linear")
ic.m2 <- glance(co2_reg_season) %>%
  dplyr::select(adj_r_squared, CV, AIC, AICc, BIC) %>% mutate(name="Linear + Seasonality")
ic.m3 <- glance(co2_quadratic) %>%
  dplyr::select(adj_r_squared, CV, AIC, AICc, BIC) %>% mutate(name="Quadratic")
ic.m4 <- glance(co2_quadratic_season) %>%
  dplyr::select(adj_r_squared, CV, AIC, AICc, BIC) %>% mutate(name="Quadratic + Seasonality")
rbind(ic.m1, ic.m2, ic.m3, ic.m4) %>% arrange(AICc, BIC) %>% knitr::kable()

```

and a quick calculation of the AIC, AICc, and BIC of all tested models confirms this theory as it has the lowest value for all aforementioned information criterion.

```{r, linear models Ljung Box Test}
lt.m1 <- augment(co2_reg) %>%
  features(.innov, ljung_box, dof = 2, lag = 24)

lt.m2 <-augment(co2_reg_season) %>%
  features(.innov, ljung_box, dof = 13, lag = 24)

lt.m3 <-augment(co2_quadratic) %>%
  features(.innov, ljung_box, dof = 3, lag = 24)

lt.m4 <-augment(co2_quadratic_season) %>%
  features(.innov, ljung_box, dof = 14, lag = 24)

rbind(lt.m1, lt.m2, lt.m3, lt.m4) %>% knitr::kable()
```
From the Ljung Box test results, the statistic for all models are high and the p-value are small, we reject the null hypothesis of no autocorrelation. We can conclude that the residuals are auto-correlated.

We then evaluate a logarithmic transformation of the data in order to gauge whether it would be a worthwhile transformation to consider in trying to improve the fit of our models.

```{r Log transformation, echo=TRUE}
ts_log_co2 <- ts_co2 %>% 
      mutate(log_co2 = log(value))
head(ts_log_co2) %>% knitr::kable()
```

Then new log-transformed data is now used to change the response variable of $CO_2$ for the same four previous models,

```{r linear log models, ,fig.height=2.5}
log_co2_reg <- ts_log_co2 %>% 
  model(TSLM(log_co2 ~ trend()))
log_co2_reg %>%
gg_tsresiduals() + ggtitle("Linear Model Residuals - Log(CO2)")
```

```{r linear seasonal log transform, fig.height=2.5}
log_co2_reg_season <- ts_log_co2 %>% 
  model(TSLM(log_co2 ~ trend()+ season()))
log_co2_reg_season %>%
gg_tsresiduals() + ggtitle("Linear Model with Seasonality Residuals - Log(CO2)")
```

```{r quad log transform, fig.height=2.5}
log_co2_quadratic <- ts_log_co2 %>% 
  model(TSLM(log_co2 ~ trend() + I(trend()^2)))
log_co2_quadratic %>%
 gg_tsresiduals() + ggtitle("Quadratic Model Residuals - Log(CO2)")
```

```{r quad seasonal log transform, fig.height=2.5}
log_co2_quadratic_season<- ts_log_co2 %>% 
  model(TSLM(log_co2 ~ trend() + I(trend()^2) +season()))
log_co2_quadratic_season %>%
 gg_tsresiduals() + ggtitle("Quadratic Model with Seasonality Residuals - Log(CO2)")
```

and no significant change can be observed in the residuals of the models. This is to be expected, however, as the exploratory data analysis above did not show a clear exponential trend in the $CO_2$ data that would need to be smoothed and correct with a logarithmic transformation, and the variance did not appear to increase or decrease over time. Therefore, a logarithmic transformation is not exactly necessary for modeling the $CO_2$ data.

We further put our best quadratic with seasonality model to the test by generating forecasts to the year 2020, and graphing the results:

```{r Forecast till 2020, echo=TRUE}
# Create a forecast object based on the model and forecast to the year 2020
save(co2_quadratic_season, file='1997_quad_seasonal_modelfit.RData')
quad.forecast <- fabletools::forecast(co2_quadratic_season, h = "23 years")
# Forecast + previous data graph
forecast.graph <- quad.forecast %>% autoplot(ts_co2) + labs(title="Linear model forecast 1997-2020", x=NULL, y="Monthly mean CO2 ppm")
forecast.graph
```

Although the forecast seems to follow along the same patterns as past $CO_2$ data, there's strong evidence from the high autocorrelation observed in the ACF of the model residuals and the lack of observed white noise residuals that this model does not perfectly fit our model. This therefore motivates exploring an ARIMA model and checking the first difference.

## ARIMA Models

We begin by first differencing the $CO_2$ data:

```{r, warning=F}
co2_diff <- diff(co2)
co2_diff2 <- ts_co2 %>%
	gg_tsdisplay(difference(value, 12) %>% difference(),
				 plot_type='partial', lag=36) +
	labs(title="Seasonally Differenced", y="")
co2_diff2
```

From the EDA, we found the $CO_2$ time series had obvious trend and seasonality. Based on the time series plot of the first difference, we now observe that the data's first difference may be stationary, and from the ACF plot, we see seasonal fluctuations every 12 lags (months). A Phillips-Perron and Augmented Dickey-Fuller test can then be run to test the alternate hypothesis that the time series is stationary, as opposed to the null hypothesis that it is explosive, or non stationary.

```{r Run the PP and ADF tests, warning=F, echo=TRUE}
PP.test(co2_diff)
adf.test(co2_diff, alternative = "stationary")
```

Both the Phillips Perron and Augmented Dickey Fuller (ADF) tests show a p-value that is less than $0.05$, therefore providing strong evidence for us to reject the null hypothesis that this time series is non stationary. Thus, the time series with the first difference is stationary and we can start to build the model with 1 difference.

```{r Fit the ARIMA models}
fit <-  ts_co2 %>%
	model(
		arima111000 = ARIMA(value ~ pdq(1,1,1) + PDQ(0,0,0)),
		arima121000 = ARIMA(value ~ pdq(1,2,1) + PDQ(0,0,0)),
		arima214000 = ARIMA(value ~ pdq(2,1,4) + PDQ(0,0,0)),
		arima012011 = ARIMA(value ~ pdq(0,1,2) + PDQ(0,1,1)),
		arima210011 = ARIMA(value ~ pdq(2,1,0) + PDQ(0,1,1)),
		arima111112 = ARIMA(value ~ pdq(1,1,1) + PDQ(1,1,2)),
		auto = ARIMA(value, stepwise = FALSE, approx = FALSE)
  )
```

```{r arima models table, echo=TRUE}
fit %>%
  report() %>% arrange(AIC) %>% 
  select(-ar_roots, -ma_roots) %>% knitr::kable()
```

```{r Best ARIMA model specs, echo=TRUE}
fit$auto[[1]]$fit$spec %>% knitr::kable()
fit$auto[[1]]$fit$model
```

After fitting numerous ARIMA models with varying specifications and running the auto model as well, we find that based on the AIC, AICc scores displayed in the table above, the auto model found to be ARIMA(0,1,3),(0,1,1)(12) has the lowest scores and is therefore the best fit model. When looking at the BIC scores, however, the lowest value was found to be for the ARIMA(0,1,2),(0,1,1)(12) model. Since we are aiming to complete more of a prediction task with our forecasting efforts rather than an explanation task and that AIC is most optimal in minimizing the mean squared error of predictions, we choose to use AIC/AICc as our main information criteria. The best fit model is therefore ARIMA(0,1,3),(0,1,1)(12), which we fit next:

```{r Best ARIMA model residual}
arima013011 <- ts_co2 %>%
  model(arima013011 = ARIMA(value ~ pdq(0,1,3) + PDQ(0,1,1)) )
# Create diagnostic plots for the residuals
arima013011%>%
  gg_tsresiduals() + ggtitle("ARIMA(0,1,3),(0,1,1)(12) Residuals")
```

```{r Save the ARIMA model to use in the other report}
saveRDS(arima013011, '1997_arima_modelfit.rds')
```

The flat mean of the residuals at 0, the roughly normally distributed residual counts, and the minimally autocorrelated/significant lags in the ACF are all strong evidence that we have white noise residuals and that the ARIMA(0,1,3),(0,1,1)(12) model fits the $CO_2$ model well.

```{r Ljung Box test, echo=TRUE}
augment(arima013011) %>%
	features(.resid, ljung_box, lag = 10, dof = 0)
```

From the Ljung Box test, we got a large p-value that failed to reject the null hypothesis, further supporting that our best model's residuals are randomly distributed, thus making it a good model fit. Generating forecast to the year 2022 with the new ARIMA model shows that the model follows the pattern of past data fairly well.

```{r ARIMA Forecast till 2020}
# Create a forecast object based on the model
save(co2_quadratic_season, file='1997_ARIMA(0,1,3),(0,1,1)(12) model.RData')

arima.forecast.2022 <- fabletools::forecast(co2_quadratic_season, h = "25 years")

# Forecast + previous data graph
arima.forecast.2022.graph <- arima.forecast.2022 %>% autoplot(ts_co2) + labs(title="ARIMA(0,1,3),(0,1,1)(12) model forecast 1997-2022", x=NULL, y="Monthly mean CO2 ppm")
arima.forecast.2022.graph
```

## Forecasts

Further forecasts can be generated to the year 2100 to test our model and make predictions about the future. We see the performance within 80% and 95% confidence intervals below, and the times the 420 and 500 ppm thersholds are crossed within the forecasts.

```{r ARIMA forecast plot, warning=F, message=FALSE}
arima_forecast <- fabletools::forecast(arima013011, h = "103 years", level = c(80, 95)) # all the way to 2100 (1997 + 103 = 2100)
arima_forecast_plot <- arima_forecast %>%
	autoplot(colour="cornflowerblue") + 
	autolayer(ts_co2, colour="black") + 
	geom_line(data=arima013011 %>% 
			  	augment(), aes(index,.fitted,color=.model)) + 
	facet_wrap(~.model, ncol=1, nrow=3) +
	geom_hline(yintercept = 420, color="steelblue") +
	geom_hline(yintercept = 500, color="steelblue") +
	labs(title="ARIMA(0,1,3)(0,1,1) forecast 1997-2100", y="Monthly mean CO2 ppm", x = NULL) +
	scale_x_yearmonth(date_breaks = "5 year", date_labels = "%Y")
arima_forecast_plot
```

```{r Produce the 420 and 500 thresholds table}
# 420
forecast.420 <- arima_forecast %>% filter(.mean >= 420 & .mean < 421) %>% hilo()
first.420 <- head(select(forecast.420, `80%`, `95%`, .mean), 1)
last.420 <- tail(select(forecast.420, `80%`, `95%`, .mean), 1)
# 500
forecast.500 <- arima_forecast %>% filter(.mean >= 500 & .mean < 501) %>% hilo()
first.500 <- head(select(forecast.500, `80%`, `95%`, .mean), 1)
last.500 <- tail(select(forecast.500, `80%`, `95%`, .mean), 1)
values.420 <- data.frame(bind_rows(first.420, last.420))
values.420$target <- 420
values.420 <- mutate(values.420,
	   ci.80.lower = X80.$lower,
	   ci.80.upper = X80.$upper,
	   ci.95.lower = X95.$lower,
	   ci.95.upper = X95.$upper
) %>% select(-X80., -X95.)
values.500 <- data.frame(bind_rows(first.500, last.500))
values.500 <- mutate(values.500,
	   ci.80.lower = X80.$lower,
	   ci.80.upper = X80.$upper,
	   ci.95.lower = X95.$lower,
	   ci.95.upper = X95.$upper
) %>% select(-X80., -X95.)
values.500$target <- 500
forecast.thresholds <- bind_rows(values.420, values.500) %>% select(target, index, .mean, starts_with('ci'))

forecast.thresholds	%>% knitr::kable()
```

The forecasts for the year 2100 in particular can be seen below:

```{r 2100 data, warning=F}
values.2100 <- filter(arima_forecast, index >= as.Date('2100-01-01')) %>% hilo() %>% data.frame()
mutate(values.2100,
	   ci.80.lower = X80.$lower,
	   ci.80.upper = X80.$upper,
	   ci.95.lower = X95.$lower,
	   ci.95.upper = X95.$upper
) %>% select(-X80., -X95.) %>% select(index, .mean, starts_with('ci')) %>% knitr::kable()
```

Although it follows the pattern of past data well, it's difficult to say if these are accurate predictions for the future, but if the current trends persist through to the year 2100, then these predictions may not be far off from the true values we will observe in $CO_2$ then.

# Conclusions

From the modeling and analysis on atmospheric $CO_{2}$ data from 1959 to 1997, we achieved our goals to answer the initial questions. Firstly, we observed and demonstrated that CO2 concentrations in the Earth's atmosphere have been increasing steadily from 1959 to 1997 and will keep increasing based on both the quadratic model and ARIMA forecast results. Secondly, both linear model and ARIMA with seasonality have better performance than models that didn't considering the seasonality. Finally, the quadratic model with seasonality and ARIMA(0,1,3),(0,1,1)(12) model fit $CO_{2}$ data well, but there's strong evidence that quadratic model has the high autocorrelation observed in the ACF of the model residuals. Therefore, the most plausible model that we estimate is ARIMA(0,1,3),(0,1,1)(12) model and we can use this model to forecast the atmospheric $CO_{2}$ changing.      


```{=tex}
\bibliographystyle{aea}
\bibliography{references}
```
```{=tex}
\appendix
\section{Appendix: Model Robustness}
```
